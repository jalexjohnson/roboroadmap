<div class="top-button">
  <h2 class="inline"><%= @project.name %> <small>Owner: <%= @project.user.name %></small></h2>
  <span class="left-spacer"></span>
  <% if current_user.admin %>
    <%= link_to edit_project_path(@project), class: "btn btn-info", role: "button" do %>
      <span class='glyphicon glyphicon-pencil' aria-hidden='true'></span> Edit
    <% end %>
    <%= link_to project_path(@project), class: "btn btn-warning", role: "button", method: :delete, data: {confirm: "Really delete?"} do %>
      <span class='glyphicon glyphicon-trash' aria-hidden='true'></span> Delete
    <% end %>
  <% end %>
</div>
<div class="top-button">
<h3 class="inline">Jobs</h3>
<span class="left-spacer"></span>
  <% if @is_owner %>
    <%= link_to new_project_job_path(@project), class: "btn btn-success", role: "button" do %>
      <span class='glyphicon glyphicon-plus' aria-hidden='true'></span> New
    <% end %>
  <% end %>
</div>
<table class="table table-striped">
  <tr>
    <th>Job Name</th>
    <th>Size</th>
    <th>Total Bid Value</th>
    <% if @current_user_bidder.present? %>
      <th>Make Bid</th>
    <% end %>
    <% if current_user.id == @project.user_id %>
      <th>Edit</th>
      <th>Delete</th>
    <% end %>
  </tr>
  <% @project.jobs.order("total_value DESC").each do |job| %>
    <tr>
      <td><%= link_to job.name, project_job_path(@project, job) %></td>
      <td><%= job.size %></td>
      <td><%= job.total_value %></td>
      <% if @current_user_bidder.present? %>
        <% bid = @current_user_bidder.bids.find_by(job_id: job.id) %>
        <% if !bid.present? %>
          <% bid = Bid.new %>
        <% end %>
        <td>
          <%= bootstrap_form_for [@project, job, bid], layout: :inline do |f| %>
            <%= f.number_field :amount, hide_label: true, min: 0, step: 1 %>
            <%= f.hidden_field :bidder_id, value: @current_user_bidder.id %>
            <%= f.hidden_field :job_id, value: job.id %>
            <%= f.submit "✔", class: "btn btn-success" %>
          <% end %>
        </td>
      <% end %>
      <% if @is_owner %>
        <td>
          <%= link_to edit_project_job_path(@project, job), class: "btn btn-info", role: "button" do %>
            <span class='glyphicon glyphicon-pencil' aria-hidden='true'></span>
          <% end %>
        </td>
        <td>
          <%= link_to project_job_path(@project, job), class: "btn btn-warning", role: "button", method: :delete, data: {confirm: "Really delete?"} do %>
            <span class='glyphicon glyphicon-trash' aria-hidden='true'></span>
          <% end %>
        </td>
      <% end %>
    </tr>
  <% end %>
</table>

<h3>Bidders</h3>
<% if @is_owner %>
  <%= bootstrap_form_tag url: project_bidders_path(@project), layout: :inline do %>
    <%= select_tag :user_id, options_from_collection_for_select(@users, :id, :name), class: "form-control" %>
    <%= number_field_tag :allowance, nil, placeholder: "Allowance", min: 1, step: 1, class: "form-control" %>
    <%= submit_tag "✔", class: "btn btn-success" %>
  <% end %>
  <br />
<% end %>
<table class="table table-striped">
  <tr>
    <th>User Name</th>
    <th>Starting Allowance</th>
    <th>Remaining Allowance</th>
    <% if current_user.id == @project.user_id %>
      <th>Edit</th>
      <th>Delete</th>
    <% end %>
  </tr>
  <% @bidders.each do |bidder| %>
    <tr>
      <td><%= bidder.user.name %></td>
      <td><%= bidder.allowance %></td>
      <td><%= bidder.remaining_allowance %></td>
      <% if @is_owner %>
        <td>
          <%= link_to edit_project_bidder_path(@project, bidder), class: "btn btn-info", role: "button" do %>
            <span class='glyphicon glyphicon-pencil' aria-hidden='true'></span>
          <% end %>
        </td>
        <td>
          <%= link_to project_bidder_path(@project, bidder), class: "btn btn-warning", role: "button", method: :delete, data: {confirm: "Really delete?"} do %>
            <span class='glyphicon glyphicon-trash' aria-hidden='true'></span>
          <% end %>
        </td>
      <% end %>
    </tr>
  <% end %>
</table>
